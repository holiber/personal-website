---
import "../styles/global.css";
import HeaderSection from '../components/HeaderSection.astro';
import FooterSection from '../components/FooterSection.astro';
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DevPro - Developer Portfolio Template</title>
    <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@300;400;700;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-950 text-gray-100 font-sans">
    <HeaderSection />
    <main id="main">
      <slot />
    </main>
    <FooterSection />
    
<script>
import Alpine from 'alpinejs';

declare global {
  interface Window {
    Alpine: typeof import('alpinejs');
  }
}

function setupIntersectionObserver() {
  // Fallback
  if (!("IntersectionObserver" in window)) {
    document.querySelectorAll("[data-progress]").forEach((element) => {
      const targetWidth = parseInt(element.getAttribute("data-progress") || "0");
      (element as HTMLElement).style.width = targetWidth + "%";
    });
    document.querySelectorAll("[data-counter]").forEach((element) => {
      const target = parseInt(element.getAttribute("data-counter") || "0");
      const suffix = element.getAttribute("data-suffix") || "";
      const prefix = element.getAttribute("data-prefix") || "";
      (element as HTMLElement).textContent = prefix + target + suffix;
    });
    return;
  }

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add("animate");

          // counter
          if (entry.target.hasAttribute("data-counter")) {
            animateCounter(entry.target as HTMLElement);
          }

          const counterElements = entry.target.querySelectorAll("[data-counter]");
          counterElements.forEach((counter) => {
            animateCounter(counter as HTMLElement);
          });

          // progress bar
          if (entry.target.hasAttribute("data-progress")) {
            animateProgress(entry.target as HTMLElement);
          }
          const progressElements = entry.target.querySelectorAll("[data-progress]");
          progressElements.forEach((progress) => {
            animateProgress(progress as HTMLElement);
          });

          observer.unobserve(entry.target);
        }
      });
    },
    {
      threshold: 0.01,
      rootMargin: "50px",
    }
  );

  // data-animate, data-counter, data-progress
  document.querySelectorAll("[data-animate], [data-counter], [data-progress]").forEach((el) => {
    observer.observe(el);
  });
}

function animateCounter(element: HTMLElement) {
  const target = parseInt(element.getAttribute("data-counter") || "0");
  const duration = parseInt(element.getAttribute("data-duration") || "2000");
  const suffix = element.getAttribute("data-suffix") || "";
  const prefix = element.getAttribute("data-prefix") || "";
  let start = 0;
  const increment = target / (duration / 16);

  const updateCounter = () => {
    start += increment;
    if (start < target) {
      element.textContent = prefix + Math.floor(start) + suffix;
      requestAnimationFrame(updateCounter);
    } else {
      element.textContent = prefix + target + suffix;
    }
  };
  updateCounter();
}

function animateProgress(element: HTMLElement) {
  const targetWidth = parseInt(element.getAttribute("data-progress") || "0");
  element.style.width = targetWidth + "%";
}

function setupSmoothScroll() {
  const backToTopButton = document.getElementById('back-to-top');
  const navLinks = document.querySelectorAll('a[data-type="smooth"]');

  window.addEventListener('scroll', () => {
    if (!backToTopButton) return;
    if (window.scrollY > 300) {
      backToTopButton.style.display = 'block';
      backToTopButton.classList.remove('opacity-0', 'invisible');
      backToTopButton.classList.add('opacity-100', 'visible');
    } else {
      backToTopButton.classList.remove('opacity-100', 'visible');
      backToTopButton.classList.add('opacity-0', 'invisible');
      setTimeout(() => {
        if (window.scrollY <= 300 && backToTopButton) {
          backToTopButton.style.display = 'none';
        }
      }, 300);
    }
  });

  if (backToTopButton) {
    backToTopButton.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });
  }

  navLinks.forEach(anchor => {
    anchor.addEventListener('click', (e) => {
      e.preventDefault();
      const href = anchor.getAttribute('href');
      if (!href) return;
      const targetId = href.substring(1);
      const targetElement = document.getElementById(targetId);
      if (targetElement) {
        const yOffset = -70; // Offset for fixed header
        const rect = targetElement.getBoundingClientRect();
        const y = rect ? rect.top + window.pageYOffset + yOffset : window.pageYOffset;
        window.scrollTo({
          top: y,
          behavior: 'smooth'
        });
      }
    });
  });
}

function setupActiveLink() {
  const navLinks = document.querySelectorAll('a[data-type="smooth"]');
  const sections = document.querySelectorAll('section[id]');

  const removeActiveClasses = () => {
    navLinks.forEach(link => link.classList.remove('active'));
  };

  const setActiveLink = (targetId: string) => {
    removeActiveClasses();
    const activeLink = Array.from(navLinks).find(link => link.getAttribute('href') === `#${targetId}`);
    if (activeLink) activeLink.classList.add('active');
  };

  const checkCurrentSection = () => {
    let current = '';
    sections.forEach(section => {
      const sectionTop = (section as HTMLElement).offsetTop - 80; // Adjust for header height
      const sectionHeight = (section as HTMLElement).clientHeight;
      if (window.pageYOffset >= sectionTop && window.pageYOffset < sectionTop + sectionHeight) {
        current = section.getAttribute('id') ?? '';
      }
    });
    if (current) {
      setActiveLink(current);
    } else if (window.pageYOffset < (sections[0] as HTMLElement).offsetTop - 80) {
      setActiveLink('home');
    }
  };

  const initializeActiveLink = () => {
    const hash = window.location.hash.substring(1);
    if (hash && document.getElementById(hash)) {
      setActiveLink(hash);
      const targetElement = document.getElementById(hash);
      const yOffset = -70;
      let y = window.pageYOffset;
      if (targetElement) {
        y = targetElement.getBoundingClientRect().top + window.pageYOffset + yOffset;
      }
      window.scrollTo({
        top: y,
        behavior: 'instant'
      });
    } else {
      checkCurrentSection();
    }
  };

  window.addEventListener('scroll', checkCurrentSection);
  window.addEventListener('hashchange', initializeActiveLink);
  initializeActiveLink();
}

document.addEventListener("DOMContentLoaded", () => {
  // Alpine.js
  window.Alpine = Alpine;
  Alpine.start();

  // IntersectionObserver
  setupIntersectionObserver();

  // Smooth Scroll
  setupSmoothScroll();
  // Active Link
  setupActiveLink();
});
</script>
  </body>
</html>